<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>rise-video test</title>

    <script src="../../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../node_modules/@polymer/test-fixture/test-fixture.js"></script>
    <script src="../../node_modules/mocha/mocha.js"></script>
    <script src="../../node_modules/chai/chai.js"></script>
    <script src="../../node_modules/sinon/pkg/sinon.js"></script>
    <script src="../../node_modules/wct-mocha/wct-mocha.js"></script>

    <script type="text/javascript">
      const FILES = "test1.mp4|test2.png|test3.webm";
      const sampleUrl = path => `https://storage.googleapis.com/${ path }`;

      RisePlayerConfiguration = {
        isConfigured: () => true,
        isPreview: () => false,
        Logger: {
          info: sinon.spy(),
          error: sinon.spy(),
          warning: sinon.spy()
        },
        LocalStorage: {
          watchSingleFile: (file, handler) => {
            handler( { status: "CURRENT", filePath: file, fileUrl: sampleUrl( file ) } );
          }
        }
      };

      const videojs = () => {
        const videojs = {
          currentSrc: sinon.spy(),
          exitFullscreen: sinon.spy(),
          getChild: sinon.spy(),
          error: sinon.spy(),
          muted: sinon.spy(),
          on: sinon.spy(),
          play: sinon.spy( sinon.stub().resolves() ),
          playlist: sinon.spy(),
          removeChild: sinon.spy(),
          videoHeight: sinon.spy(),
          videoWidth: sinon.spy(),
          volume: sinon.spy()
        };

        videojs.playlist.currentItem = sinon.spy();
        videojs.playlist.first = sinon.spy();
        videojs.playlist.next = sinon.spy();

        return videojs;
      };
    </script>

    <script type="module" src="../../src/rise-video.js"></script>
  </head>
  <body>

    <test-fixture id="test-block">
      <template>
        <rise-video
          id="rise-video-01"
          files="test1.mp4|test2.png|test3.webm">
        </rise-video>
      </template>
    </test-fixture>

    <script type="module">
      let element;

      setup (() => {
        element = fixture("test-block");
      } );

      suite( "logging", () => {
        const componentData = {
          name: "rise-video",
          id: "rise-video-01",
          version: "__VERSION__"
        };

        test( "should log 'video-start' event with correct params", () => {
          element.dispatchEvent( new CustomEvent( "start" ) );

          assert.deepEqual( RisePlayerConfiguration.Logger.info.lastCall.args[ 0 ], componentData );
          assert.equal( RisePlayerConfiguration.Logger.info.lastCall.args[ 1 ], "video-start" );
          assert.deepEqual( RisePlayerConfiguration.Logger.info.lastCall.args[ 2 ], { files: FILES } );
        } );

        test( "should log 'video-reset' event with correct params when files change", () => {
          element.files = "foo.mp4|bar.webm";

          assert.equal( RisePlayerConfiguration.Logger.info.lastCall.args[ 1 ], "video-reset" );
          assert.deepEqual( RisePlayerConfiguration.Logger.info.lastCall.args[ 2 ], { files: "foo.mp4|bar.webm" } );
        } );

        test( "should log 'video-reset' event with correct params when metadata changes", () => {
          element.metadata = [ { file: "foo.mp4" }, { file: "bar.webm" } ];

          assert.equal( RisePlayerConfiguration.Logger.info.lastCall.args[ 1 ], "video-reset" );
          assert.deepEqual( RisePlayerConfiguration.Logger.info.lastCall.args[ 2 ], { files: [ "foo.mp4", "bar.webm" ] } );
        } );
      } );

      suite( "rise-video", () => {
        test( "component exists", () => {
          assert.isOk( element );
        } );

        test( "_initialStart is updated correctly", () => {
          assert.isTrue( element._initialStart );

          element.dispatchEvent( new CustomEvent( "start" ) );

          assert.isFalse( element._initialStart );
        });
      });

      suite( "valid filenames", () => {
        test( "invalid files are filtered out", () => {
          element.dispatchEvent( new CustomEvent( "start" ) );

          assert.deepEqual( element._validFiles, [ "test1.mp4", "test3.webm" ] );
        } );

        test( "valid filenames are updated when files property changes", () => {
          element.files = "foo.mp4|bar.webm|baz.jpg";

          assert.deepEqual( element._validFiles, [ "foo.mp4", "bar.webm" ] );
        });

        test( "valid filenames are updated when metadata property changes", () => {
          element.metadata = [ { file: "foo.mp4" }, { file: "bar.webm" }, { file: "baz.jpg" } ];

          assert.deepEqual( element._validFiles, [ "foo.mp4", "bar.webm" ] );
        });
      } );

      suite( "watched files", () => {
        test( "files to render should be populated", () => {
          element.dispatchEvent( new CustomEvent( "start" ) );

          assert.equal( element._filesToRenderList.length, 2 );
        } );

        test( "deleted files should be removed from list of files to render", () => {
          element.dispatchEvent( new CustomEvent( "start" ) );

          element._handleSingleFileUpdate( {
            filePath: "test3.webm",
            fileUrl: sampleUrl( "test3.webm" ),
            status: "deleted",
          } );

          assert.equal( element._filesToRenderList.length, 1 );
        } );

        test( "errors should be handled", () => {
          sinon.stub( RisePlayerConfiguration.LocalStorage, 'watchSingleFile').callsFake( (file, handler) => {
            handler({
              filePath: file,
              fileUrl: null,
              status: "FILE-ERROR",
              errorMessage: "download error",
              errorDetail: "network failure"
            } );
          } );
          sinon.spy( element, "watchedFileErrorCallback" );

          element.dispatchEvent( new CustomEvent( "start" ) );

          assert.equal( element.watchedFileErrorCallback.callCount, 2 );
          assert.equal( element._filesToRenderList.length, 0 );

          RisePlayerConfiguration.LocalStorage.watchSingleFile.restore();
          element.watchedFileErrorCallback.restore();
        } );

        test( "watched files are updated when files property changes", () => {
          element.files = "foo.mp4|bar.webm|baz.jpg";

          assert.deepEqual( element.managedFiles, [ { filePath: "foo.mp4", fileUrl: sampleUrl("foo.mp4"), order: 0 }, { filePath: "bar.webm", fileUrl: sampleUrl("bar.webm"), order: 1 } ] );
        });

        test( "watched files are updated when metadata property changes", () => {
          element.metadata = [ { file: "foo.mp4" }, { file: "bar.webm" }, { file: "baz.jpg" } ];

          assert.deepEqual( element.managedFiles, [ { filePath: "foo.mp4", fileUrl: sampleUrl("foo.mp4"), order: 0 }, { filePath: "bar.webm", fileUrl: sampleUrl("bar.webm"), order: 1 } ] );
        });
      } );

      suite( "volume", () => {
        test( "volume defaults to 0", () => {
          assert.strictEqual( element.volume, 0 );
        } );

        test( "volume updates in video player when changed", () => {
          element.volume = 75;
          
          assert.strictEqual( element.$.videoPlayer.volume, 75 );
        } );
      } );
    </script>

  </body>
</html>
